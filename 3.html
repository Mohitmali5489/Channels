<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast ID Reader</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body {
            background-color: #111;
            color: white;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* The Camera View */
        .camera-wrapper {
            position: relative;
            width: 100%;
            height: 60vh;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6; /* Dim the background to highlight the scan box */
        }

        /* The "Scan Zone" Box */
        .scan-box {
            position: absolute;
            width: 80%;
            height: 60px; /* Small height = Faster processing */
            border: 2px solid #00ff00;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); /* Darken everything else */
            z-index: 10;
            border-radius: 8px;
        }
        
        .scan-line {
            width: 100%;
            height: 2px;
            background: #00ff00;
            position: absolute;
            top: 50%;
            animation: scanMove 2s infinite;
        }

        @keyframes scanMove {
            0% { top: 10%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }

        .instructions {
            padding: 15px;
            text-align: center;
            font-size: 0.9rem;
            color: #ccc;
        }

        /* Result Area */
        .result-area {
            flex: 1;
            width: 100%;
            background: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-top: 1px solid #444;
        }

        #detected-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00ff00;
            font-family: monospace;
            letter-spacing: 3px;
        }

        .status {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        /* Manual Override */
        .manual-btn {
            margin-top: 10px;
            padding: 8px 20px;
            background: #444;
            border: 1px solid #666;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="camera-wrapper">
        <video id="video" autoplay playsinline></video>
        <div class="scan-box">
            <div class="scan-line"></div>
        </div>
    </div>

    <div class="instructions">
        Align <b>Student Id : 5207872</b> inside the box.
    </div>

    <div class="result-area">
        <div id="detected-text">-------</div>
        <div class="status" id="status-msg">Initializing engine...</div>
        <button class="manual-btn" onclick="askManual()">Scanner Stuck? Type ID</button>
    </div>

    <canvas id="hiddenCanvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const statusMsg = document.getElementById('status-msg');
        const resultDisplay = document.getElementById('detected-text');
        const canvas = document.getElementById('hiddenCanvas');
        const ctx = canvas.getContext('2d');
        
        let isScanning = false;
        let worker = null;

        // 1. Initialize Camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                video.srcObject = stream;
                video.play();
                initTesseract();
            })
            .catch(err => {
                statusMsg.innerText = "Camera Error: " + err.message;
            });

        // 2. Initialize Tesseract Worker
        async function initTesseract() {
            worker = Tesseract.createWorker({
                logger: m => {
                    if(m.status === 'recognizing text') {
                        statusMsg.innerText = `Scanning... ${(m.progress * 100).toFixed(0)}%`;
                    }
                }
            });
            
            await worker.load();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            
            // OPTIMIZATION: Tell Tesseract to only look for numbers and simple text
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789StudentId:. ' 
            });

            statusMsg.innerText = "Ready. Hold steady.";
            startLoop();
        }

        // 3. The Scan Loop
        async function startLoop() {
            if(isScanning) return;
            
            // Scan interval: Every 800ms
            setInterval(async () => {
                if (isScanning) return;
                isScanning = true;

                try {
                    // Capture ONLY the center strip (The green box area)
                    // The box is roughly middle 15% of height
                    const w = video.videoWidth;
                    const h = video.videoHeight;
                    
                    if (w && h) {
                        canvas.width = w;
                        canvas.height = h * 0.2; // Capture 20% strip height
                        
                        // Draw the center slice of video onto canvas
                        // sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight
                        ctx.drawImage(video, 0, h * 0.4, w, h * 0.2, 0, 0, canvas.width, canvas.height);
                        
                        // PRE-PROCESSING: Increase Contrast (Optional but helpful)
                        // This makes grey text black and background white
                        enhanceImage(ctx, canvas.width, canvas.height);

                        const { data: { text } } = await worker.recognize(canvas);
                        
                        console.log("Saw:", text);
                        
                        // Check for 7 digits
                        const match = text.match(/(\d{7})/);
                        if (match) {
                            foundId(match[0]);
                        } else {
                            isScanning = false;
                        }
                    } else {
                        isScanning = false;
                    }
                } catch (e) {
                    console.error(e);
                    isScanning = false;
                }
            }, 1000);
        }

        // Helper: Simple high contrast filter
        function enhanceImage(ctx, w, h) {
            const imageData = ctx.getImageData(0, 0, w, h);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                // Grayscale
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // Threshold (Binary Black/White)
                const color = avg > 100 ? 255 : 0; 
                data[i] = color;
                data[i + 1] = color;
                data[i + 2] = color;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function foundId(id) {
            resultDisplay.innerText = id;
            statusMsg.innerText = "SUCCESS!";
            statusMsg.style.color = "#00ff00";
            // Stop scanning loop by NOT setting isScanning back to false immediately
            
            // Vibration feedback
            if (navigator.vibrate) navigator.vibrate(200);
            
            alert("ID FOUND: " + id);
        }
        
        function askManual() {
            let id = prompt("Enter the 7-digit ID manually:");
            if(id) foundId(id);
        }
    </script>
</body>
</html>
