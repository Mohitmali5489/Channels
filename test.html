<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SY-BAF Confessions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.skypack.dev/@octokit/core"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f9f9f9;
      padding: 20px;
      color: #222;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .button-group button {
      background-color: #fff;
      color: #333;
      border: 1px solid #333;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .button-group button.active {
      background-color: #b84fff;
      color: white;
    }

    .input-bar {
      display: flex;
      max-width: 600px;
      margin: 0 auto 20px auto;
    }

    .input-bar input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px 0 0 6px;
      font-size: 14px;
    }

    .input-bar button {
      padding: 12px;
      background-color: #b84fff;
      border: none;
      color: white;
      font-size: 18px;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
    }

    .message {
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
      color: red;
    }
  </style>
</head>
<body>

  <h1>SY-BAF College Confessions</h1>

  <div class="button-group">
    <button id="anonBtn" onclick="selectUser('anonymous')">Anonymous</button>
    <button id="userBtn" onclick="selectUser('user')">Loading...</button>
  </div>

  <div class="input-bar">
    <input type="text" id="confessInput" placeholder="ðŸŒŸ What's on your mind?" />
    <button onclick="submitConfession()">âž¤</button>
  </div>

  <div class="message" id="message"></div>

  <script>
    let selectedUser = 'anonymous';
    let actualUserName = 'User';
    let actualProfilePic = '';
    const roll = getCookie("roll");

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function selectUser(type) {
      selectedUser = type;
      document.getElementById("anonBtn").classList.toggle("active", type === 'anonymous');
      document.getElementById("userBtn").classList.toggle("active", type === 'user');
    }

    async function loadUsername() {
      if (!roll) {
        document.getElementById("userBtn").textContent = "Unknown User";
        return;
      }

      try {
        const res = await fetch("https://mohitmali5489.github.io/Channels/data.json");
        const data = await res.json();
        const user = data.find(u => u.ROLL == roll);
        if (user) {
          actualUserName = user.NAME;
          actualProfilePic = user.img || '';
          document.getElementById("userBtn").textContent = actualUserName;
        } else {
          document.getElementById("userBtn").textContent = "User Not Found";
        }
      } catch (err) {
        document.getElementById("userBtn").textContent = "Error Loading";
        console.error("Error:", err);
      }
    }

    async function submitConfession() {
      const input = document.getElementById("confessInput").value.trim();
      const msgEl = document.getElementById("message");
      msgEl.textContent = '';

      if (!input) {
        msgEl.textContent = "Please write a confession.";
        return;
      }

      if (!roll || isNaN(roll)) {
        msgEl.textContent = "User not logged in.";
        return;
      }

      const confession = {
        Pic: selectedUser === 'anonymous'
          ? "https://i.ibb.co/23tWNzjt/anon.png"
          : actualProfilePic || "https://via.placeholder.com/40",
        Name: selectedUser === 'anonymous' ? "Anonymous" : actualUserName,
        Confess: input,
        Tick: "blue",
        Roll: roll
      };

      try {
        // Load current data from GitHub
        const apiUrl = `https://api.github.com/repos/YOUR-USERNAME/YOUR-REPO/contents/confessions.json`;
        const res = await fetch(apiUrl, {
          headers: { Authorization: 'Bearer YOUR-TOKEN' }
        });
        const current = await res.json();
        const existing = JSON.parse(atob(current.content));
        existing.push(confession);

        const { Octokit } = window.octokit;
        const octokit = new Octokit({ auth: 'YOUR-TOKEN' });

        await octokit.request('PUT /repos/YOUR-USERNAME/YOUR-REPO/contents/confessions.json', {
          owner: 'YOUR-USERNAME',
          repo: 'YOUR-REPO',
          path: 'confessions.json',
          message: 'New confession submitted',
          committer: {
            name: actualUserName,
            email: 'you@example.com'
          },
          content: btoa(JSON.stringify(existing, null, 2)),
          sha: current.sha,
          headers: {
            'X-GitHub-Api-Version': '2022-11-28'
          }
        });

        msgEl.style.color = "green";
        msgEl.textContent = "Confession submitted successfully!";
        document.getElementById("confessInput").value = "";

      } catch (err) {
        console.error("Submit error:", err);
        msgEl.textContent = "Failed to submit. " + (err?.response?.status || err.message);
      }
    }

    // Initialize
    loadUsername();
    selectUser('anonymous');
  </script>
</body>
</html>
