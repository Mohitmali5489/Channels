<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>University of Mumbai Result PDF â†’ JSON</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f6;
  padding: 20px;
}
.container {
  background: #fff;
  max-width: 1200px;
  margin: auto;
  padding: 25px;
  border-radius: 8px;
}
button {
  padding: 10px 18px;
  margin-right: 10px;
  cursor: pointer;
}
pre {
  background: #111;
  color: #0f0;
  padding: 15px;
  max-height: 450px;
  overflow: auto;
  font-size: 13px;
}
</style>
</head>

<body>
<div class="container">
  <h2>ðŸ“„ University of Mumbai Result PDF â†’ JSON</h2>

  <input type="file" id="pdfFile" accept="application/pdf" />
  <br /><br />

  <button onclick="processPDF()">Generate JSON</button>
  <button onclick="downloadJSON()">Download JSON</button>

  <h3>JSON Preview</h3>
  <pre id="output">[]</pre>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let finalData = [];

async function processPDF() {
  console.clear();
  console.log("ðŸ”µ Starting PDF processing");

  const file = document.getElementById("pdfFile").files[0];
  if (!file) return alert("Upload a PDF first");

  const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
  let lines = [];

  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();

    let rows = {};
    content.items.forEach(item => {
      const y = Math.round(item.transform[5]);
      if (!rows[y]) rows[y] = [];
      rows[y].push(item.str);
    });

    Object.values(rows).forEach(r => {
      const line = r.join(" ").replace(/\s+/g, " ").trim();
      if (line.length) lines.push(line);
    });
  }

  console.log("ðŸŸ¢ Total lines:", lines.length);
  parseStudents(lines);

  document.getElementById("output").textContent =
    JSON.stringify(finalData, null, 2);
}

/* ======================================
   STUDENT HEADER â€” FINAL & CORRECT
====================================== */

function parseStudents(lines) {
  finalData = [];

  const studentRegex =
    /^(\d{9})\s+([A-Z\s]+?)\s+Regular\s+(MALE|FEMALE)\s+\((MU\d+)\)/;

  for (let i = 0; i < lines.length; i++) {
    const m = lines[i].match(studentRegex);
    if (!m) continue;

    const student = {
      student: {
        seat_no: m[1],
        name: m[2].trim(),
        status: "Regular",
        gender: m[3],
        ern: m[4],
        college: {
          code: "MU-1122",
          name:
            "Kalyan Citizens Education Society's B K Birla Night Arts Science and Commerce College"
        }
      },
      subjects: [],
      semester_summary: {}
    };

    console.log("âœ… Student found:", student.student.seat_no, student.student.name);

    extractSubjects(lines, i, student);
    extractSemesterSummary(lines, i, student);

    finalData.push(student);
  }

  console.log("ðŸŸ¢ Total students:", finalData.length);
}

/* ======================================
   SUBJECT PARSER (SAFE BASE VERSION)
====================================== */

function extractSubjects(lines, startIndex, student) {
  for (let i = startIndex; i < startIndex + 250 && i < lines.length; i++) {
    const line = lines[i];

    const m = line.match(
      /^(\d{7})\s+(MAJOR|MINOR|OE|SEC|AECC|VEC|CO-CURRICULAR)\s+(.+?)\s+TH\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+\.\d+)\s+([A+OBCDF]+)\s+(\d+\.\d+)\s+([PF])/
    );

    if (!m) continue;

    student.subjects.push({
      course_code: m[1],
      vertical: m[2],
      course_name: m[3].trim(),
      exam_type: "TH",
      marks: {
        cia: { max: +m[4], min: +m[5], obtained: +m[6] },
        see: { max: +m[7], min: +m[8], obtained: +m[9] },
        total: { max: +m[10], min: +m[11], obtained: +m[12] }
      },
      credits: +m[13],
      grade: m[14],
      grade_point: gradePoint(m[14]),
      credit_points: +m[15],
      remark: m[16]
    });
  }
}

/* ======================================
   SEMESTER SUMMARY
====================================== */

function extractSemesterSummary(lines, startIndex, student) {
  for (let i = startIndex; i < startIndex + 400 && i < lines.length; i++) {
    const m = lines[i].match(
      /Credits\s*:?(\d+\.\d+).*EGP\s*:?(\d+\.\d+).*Percentage\s*:?(\d+\.\d+).*GRADE\s*:?([A+OBCDF]+).*SGPA\s*:?(\d+\.\d+)/
    );
    if (!m) continue;

    student.semester_summary = {
      semester: "II",
      total_credits: +m[1],
      earned_grade_points: +m[2],
      percentage: +m[3],
      grade: m[4],
      sgpa: +m[5],
      result: "PASS"
    };
    break;
  }
}

/* ======================================
   UTILS
====================================== */

function gradePoint(g) {
  return { O: 10, "A+": 9, A: 8, "B+": 7, B: 6, C: 5, D: 4, F: 0 }[g] || 0;
}

function downloadJSON() {
  if (!finalData.length) return alert("No data to download");

  const blob = new Blob([JSON.stringify(finalData, null, 2)], {
    type: "application/json"
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mu_results.json";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
