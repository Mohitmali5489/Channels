<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>University of Mumbai Result PDF â†’ JSON</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f6;
  padding: 20px;
}
.container {
  background: #fff;
  max-width: 1200px;
  margin: auto;
  padding: 25px;
  border-radius: 8px;
}
button {
  padding: 10px 18px;
  margin-right: 10px;
  cursor: pointer;
}
pre {
  background: #111;
  color: #0f0;
  padding: 15px;
  max-height: 450px;
  overflow: auto;
  font-size: 13px;
}
</style>
</head>

<body>
<div class="container">
  <h2>ðŸ“„ University of Mumbai Result PDF â†’ JSON</h2>

  <input type="file" id="pdfFile" accept="application/pdf" />
  <br /><br />

  <button onclick="processPDF()">Generate JSON</button>
  <button onclick="downloadJSON()">Download JSON</button>

  <h3>JSON Preview</h3>
  <pre id="output">[]</pre>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let finalData = [];

/* ============================
   MAIN
============================ */

async function processPDF() {
  console.clear();
  console.log("ðŸ”µ Starting PDF processing");

  const file = document.getElementById("pdfFile").files[0];
  if (!file) {
    alert("Upload a PDF first");
    return;
  }

  const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
  let lines = [];

  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();

    let rows = {};
    content.items.forEach(item => {
      const y = Math.round(item.transform[5]);
      if (!rows[y]) rows[y] = [];
      rows[y].push(item.str);
    });

    Object.values(rows).forEach(r => {
      const line = r.join(" ").replace(/\s+/g, " ").trim();
      if (line.length) lines.push(line);
    });
  }

  console.log("ðŸŸ¢ Total lines:", lines.length);
  parseStudents(lines);

  document.getElementById("output").textContent =
    JSON.stringify(finalData, null, 2);
}

/* ============================
   STUDENT PARSING
============================ */

function parseStudents(lines) {
  finalData = [];

  for (let i = 0; i < lines.length; i++) {
    // Seat No + Name line
    if (/^\d{9}\s+[A-Z\s]+$/.test(lines[i])) {
      const parts = lines[i].split(" ");
      const seatNo = parts.shift();
      const name = parts.join(" ").trim();

      const genderLine = lines[i + 2] || "";
      const ernLine = lines[i + 3] || "";

      if (!/(MALE|FEMALE)/.test(genderLine)) continue;

      const student = {
        student: {
          seat_no: seatNo,
          name,
          status: "Regular",
          gender: genderLine.includes("MALE") ? "MALE" : "FEMALE",
          ern: ernLine.replace(/[()]/g, ""),
          college: {
            code: "MU-1122",
            name:
              "Kalyan Citizens Education Society's B K Birla Night Arts Science and Commerce College"
          }
        },
        subjects: [],
        semester_summary: {}
      };

      extractSubjects(lines, i, student);
      extractSummary(lines, i, student);

      finalData.push(student);
      console.log("âœ… Student parsed:", seatNo, name);
    }
  }

  console.log("ðŸŸ¢ Total students:", finalData.length);
}

/* ============================
   SUBJECT PARSING (SAFE)
============================ */

function extractSubjects(lines, startIndex, student) {
  for (let i = startIndex; i < startIndex + 200 && i < lines.length; i++) {
    const line = lines[i];

    // Typical subject row contains course code + credits + grade
    const match = line.match(
      /(\d{7})\s+(Financial|Auditing|Introduction|Vocational|Lekhan|Environmental|Social|Foundation|Sports).*?(\d+\.\d{2})\s+([A+OBCDF]+)\s+(\d+\.\d{2})/
    );

    if (!match) continue;

    student.subjects.push({
      course_code: match[1],
      vertical: "NA",
      course_name: match[2],
      exam_type: "TH",
      marks: {
        cia: {},
        see: {},
        total: {}
      },
      credits: parseFloat(match[3]),
      grade: match[4],
      grade_point: gradePoint(match[4]),
      credit_points: parseFloat(match[5]),
      remark: "P"
    });
  }
}

/* ============================
   SEMESTER SUMMARY
============================ */

function extractSummary(lines, startIndex, student) {
  for (let i = startIndex; i < startIndex + 300 && i < lines.length; i++) {
    const line = lines[i];

    if (line.includes("Credits") && line.includes("SGPA")) {
      const m = line.match(
        /Credits\s*:?(\d+\.\d+).*?EGP\s*:?(\d+\.\d+).*?Percentage\s*:?(\d+\.\d+).*?GRADE\s*:?([A+OBCDF]+).*?SGPA\s*:?(\d+\.\d+)/
      );
      if (!m) continue;

      student.semester_summary = {
        semester: "II",
        total_credits: parseFloat(m[1]),
        earned_grade_points: parseFloat(m[2]),
        percentage: parseFloat(m[3]),
        grade: m[4],
        sgpa: parseFloat(m[5]),
        result: "PASS"
      };
      break;
    }
  }
}

/* ============================
   UTIL
============================ */

function gradePoint(g) {
  return { O: 10, "A+": 9, A: 8, "B+": 7, B: 6, C: 5, D: 4, F: 0 }[g] || 0;
}

/* ============================
   DOWNLOAD
============================ */

function downloadJSON() {
  if (!finalData.length) {
    alert("No data to download");
    return;
  }
  const blob = new Blob([JSON.stringify(finalData, null, 2)], {
    type: "application/json"
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mu_results.json";
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
