<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bigg Boss Style Voting</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- BIGG BOSS THEME --- */
        :root {
            --bg-dark: #0F172A;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --neon-gold: #FFD700;
            --neon-pink: #FF007F;
            --text-white: #FFFFFF;
            --card-bg: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-white);
            min-height: 100vh;
            padding-bottom: 100px; /* Space for vote button */
            background-attachment: fixed;
        }

        /* --- HEADER --- */
        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky; top: 0; z-index: 50;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(to right, #FFD700, #FF8C00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .sub-header { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; }

        /* --- SECTION TITLES --- */
        .category-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 30px 0 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .category-title::before, .category-title::after {
            content: "";
            height: 2px;
            width: 30px;
            background: var(--neon-gold);
            display: block;
        }

        /* --- GRID LAYOUT --- */
        .contestant-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 items per row like Bigg Boss */
            gap: 15px 10px;
            padding: 0 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* --- CONTESTANT CARD --- */
        .contestant {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        /* The Circular Image Wrapper */
        .avatar-circle {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            background: #333;
            border: 3px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .avatar-circle img {
            width: 100%; height: 100%; object-fit: cover;
        }
        
        /* Placeholder Icon style */
        .avatar-icon {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: #aaa; background: #222;
        }

        /* Name & Emoji */
        .name-plate {
            margin-top: 8px;
            text-align: center;
        }
        
        .c-name {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            color: #ddd;
        }
        
        .c-emoji { font-size: 1rem; margin-left: 3px; }

        /* --- SELECTION STATE (The "Glow") --- */
        /* Hidden Radio */
        input[type="radio"] { display: none; }

        /* When Selected */
        input[type="radio"]:checked + .contestant-visual .avatar-circle {
            border-color: var(--neon-gold);
            box-shadow: 0 0 20px var(--neon-gold), inset 0 0 10px var(--neon-gold);
            transform: scale(1.1);
        }

        input[type="radio"]:checked + .contestant-visual .c-name {
            color: var(--neon-gold);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        /* Checkmark Badge */
        .check-badge {
            position: absolute;
            bottom: 0; right: 0;
            background: var(--neon-gold);
            color: black;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            opacity: 0; transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #000;
        }

        input[type="radio"]:checked + .contestant-visual .check-badge {
            opacity: 1; transform: scale(1);
        }

        /* --- BOTTOM ACTION BAR --- */
        .vote-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 15px 20px 25px;
            background: linear-gradient(to top, #000 20%, transparent);
            display: flex; justify-content: center;
            z-index: 100;
            pointer-events: none; /* Let clicks pass through gradient area */
        }

        .vote-btn {
            pointer-events: auto;
            background: linear-gradient(90deg, #FF512F 0%, #DD2476 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 25px rgba(221, 36, 118, 0.6);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex; align-items: center; gap: 10px;
        }

        .vote-btn:active { transform: scale(0.95); }

        /* Loading Overlay */
        #authOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,215,0,0.3);
            border-top: 5px solid var(--neon-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="spinner"></div>
        <div style="text-transform:uppercase; letter-spacing:2px; font-size:0.8rem;">Accessing Voting Lines...</div>
    </div>

    <header>
        <div class="logo">EcoCampus Voting</div>
        <div class="sub-header" id="userWelcome">Guest Voter</div>
    </header>

    <form id="votingForm">
        
        <div class="category-title">Mr. Birla</div>
        
        <div class="contestant-grid">
            <label class="contestant">
                <input type="radio" name="mr_birla" value="Aashish Santosh Yadav">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Aashish</span>
                        <span class="c-emoji">üòé</span>
                    </div>
                </div>
            </label>

            <label class="contestant">
                <input type="radio" name="mr_birla" value="Krushnakant Pal">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Krushna</span>
                        <span class="c-emoji">üî•</span>
                    </div>
                </div>
            </label>

            <label class="contestant">
                <input type="radio" name="mr_birla" value="Suraj Ramsudhakar Yadav">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Suraj</span>
                        <span class="c-emoji">ü¶Å</span>
                    </div>
                </div>
            </label>
            
             <label class="contestant">
                <input type="radio" name="mr_birla" value="Yashraj Dattatray Gaikwad">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Yashraj</span>
                        <span class="c-emoji">üí™</span>
                    </div>
                </div>
            </label>
            
             <label class="contestant">
                <input type="radio" name="mr_birla" value="Prasad Pankaj Jawale">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Prasad</span>
                        <span class="c-emoji">üåü</span>
                    </div>
                </div>
            </label>
        </div>

        <div class="category-title" style="margin-top: 50px;">Miss. Birla</div>

        <div class="contestant-grid">
            <label class="contestant">
                <input type="radio" name="miss_birla" value="Vaidehi Balu Gund">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Vaidehi</span>
                        <span class="c-emoji">üëë</span>
                    </div>
                </div>
            </label>

            <label class="contestant">
                <input type="radio" name="miss_birla" value="Ekta Mukesh Dixit">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Ekta</span>
                        <span class="c-emoji">‚ú®</span>
                    </div>
                </div>
            </label>

            <label class="contestant">
                <input type="radio" name="miss_birla" value="Divya Anand Nair">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Divya</span>
                        <span class="c-emoji">üíñ</span>
                    </div>
                </div>
            </label>
            
            <label class="contestant">
                <input type="radio" name="miss_birla" value="Dharani Shankar Mudaliyar">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Dharani</span>
                        <span class="c-emoji">ü¶ã</span>
                    </div>
                </div>
            </label>
            
            <label class="contestant">
                <input type="radio" name="miss_birla" value="Kaustubhi Chavan">
                <div class="contestant-visual">
                    <div class="avatar-circle">
                        <div class="avatar-icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="check-badge"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="name-plate">
                        <span class="c-name">Kaustubhi</span>
                        <span class="c-emoji">üå∏</span>
                    </div>
                </div>
            </label>
        </div>

    </form>

    <div class="vote-bar">
        <button class="vote-btn" onclick="submitVote()">
            VOTE NOW <i class="fas fa-bolt"></i>
        </button>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://uvlwqlddmanuzeuqtjxp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_LIyHXHGq6pqfAcWw-QCz9g_N9lfVNOA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentStudentId = null;

        // AUTH
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('id');

            if (!studentId) {
                Swal.fire({
                    icon: 'error', title: 'ACCESS DENIED',
                    text: 'Invalid Voting Link',
                    background: '#222', color: '#fff', confirmButtonColor: '#FFD700'
                });
                return;
            }

            const { data, error } = await supabase
                .from('allowed_students')
                .select('full_name')
                .eq('student_id', studentId)
                .single();

            if (error || !data) {
                Swal.fire({
                    icon: 'error', title: 'INVALID ID',
                    background: '#222', color: '#fff', confirmButtonColor: '#FFD700'
                });
            } else {
                currentStudentId = studentId;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('userWelcome').innerText = `Welcome, ${data.full_name}`;
            }
        };

        // FINGERPRINT & VOTE (Same Secure Logic)
        async function getDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = "top"; ctx.font = "14px 'Arial'";
            ctx.fillStyle = "#f60"; ctx.fillRect(125,1,62,20);
            ctx.fillStyle = "#069"; ctx.fillText("EcoCampusVote", 2, 15);
            const canvasHash = canvas.toDataURL();
            const components = [navigator.userAgent, window.screen.width + 'x' + window.screen.height, new Date().getTimezoneOffset(), canvasHash].join('||');
            const msgBuffer = new TextEncoder().encode(components);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function submitVote() {
            const mr = document.querySelector('input[name="mr_birla"]:checked');
            const miss = document.querySelector('input[name="miss_birla"]:checked');

            if (!mr || !miss) {
                Swal.fire({
                    title: 'INCOMPLETE!',
                    text: 'You must select one contestant from each category.',
                    icon: 'warning',
                    background: '#222', color: '#fff', confirmButtonColor: '#FFD700'
                });
                return;
            }

            Swal.showLoading();

            try {
                if (!navigator.geolocation) throw new Error("GPS Required");
                
                const fingerprint = await getDeviceFingerprint();

                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        const { data, error } = await supabase.rpc('submit_secure_vote', {
                            vote_mr: mr.value,
                            vote_miss: miss.value,
                            client_device_hash: fingerprint,
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude,
                            p_student_id: currentStudentId
                        });

                        if (data && data.success) {
                            Swal.fire({
                                icon: 'success', title: 'VOTE SAVED!',
                                text: 'Your vote has been locked securely.',
                                background: '#222', color: '#fff', confirmButtonColor: '#FFD700'
                            });
                        } else {
                            let msg = "Validation Failed";
                            if (data.error === 'OUTSIDE_RADIUS') msg = "You are outside the campus zone.";
                            if (data.error === 'DEVICE_ALREADY_VOTED') msg = "Device already voted.";
                            if (data.error === 'STUDENT_ALREADY_VOTED') msg = "You have already voted.";
                            
                            Swal.fire({
                                icon: 'error', title: 'VOTE REJECTED',
                                text: msg,
                                background: '#222', color: '#fff', confirmButtonColor: '#d33'
                            });
                        }
                    },
                    (err) => {
                        Swal.fire({
                            icon: 'error', title: 'GPS ERROR',
                            text: 'Please allow location access to vote.',
                            background: '#222', color: '#fff'
                        });
                    },
                    { enableHighAccuracy: true }
                );

            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>
