<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grand Finale | EcoCampus</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg:#050505; --card:#111; --gold:#FFD700; --gold-dim: #998100;
            --grad: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #998100 100%);
        }
        body { margin:0; background:var(--bg); color:#fff; font-family:'Outfit',sans-serif; padding-bottom:100px; user-select:none; }
        
        /* HEADER */
        header { position:sticky; top:0; z-index:100; background:rgba(5,5,5,0.95); backdrop-filter:blur(10px); padding:20px; border-bottom:1px solid rgba(255,215,0,0.1); text-align:center; }
        .badge { background: #333; color: #fff; font-size: 0.6rem; padding: 4px 8px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: inline-block; }
        .logo { font-weight:900; font-size:1.8rem; background:var(--grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-transform: uppercase; letter-spacing: -1px; }
        #timer { font-size:1.2rem; font-weight:700; color:var(--gold); margin-top:5px; font-variant-numeric: tabular-nums; }

        .container { max-width:600px; margin:0 auto; padding:20px; }
        h4 { color:var(--gold); border-bottom: 1px solid #333; padding-bottom: 10px; margin: 30px 0 15px; text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; }

        /* SELECTION CARDS */
        .card { 
            display:flex; align-items:center; background:var(--card); 
            border:1px solid #333; border-radius:16px; padding:15px; margin-bottom:12px; cursor:pointer; 
            transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            opacity: 0.6; transform: scale(0.98);
        }
        .card.selected { 
            border-color:var(--gold); background: #1a1a1a; 
            opacity: 1; transform: scale(1);
            box-shadow: 0 0 20px rgba(255,215,0,0.1);
        }
        .avatar { width:60px; height:60px; border-radius:50%; object-fit:cover; margin-right:20px; background:#222; border:2px solid #333; }
        .card.selected .avatar { border-color: var(--gold); }
        .info { flex:1; } 
        .name { font-weight:700; font-size:1.1rem; margin-bottom: 2px; } 
        .role { font-size:0.8rem; color:#888; }
        
        /* CHECKBOX CIRCLE */
        .check { 
            width:24px; height:24px; border-radius:50%; border:2px solid #444; 
            display:flex; align-items:center; justify-content:center; transition:0.2s;
        }
        .card.selected .check { background:var(--gold); border-color:var(--gold); }
        .card.selected .check::after { content:'âœ”'; color:#000; font-size:14px; font-weight:800; }

        /* OVERLAYS */
        #overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding: 20px; }
        .icon-lock { font-size: 3rem; margin-bottom: 20px; color: #444; }
        .blur { filter:blur(15px); pointer-events:none; opacity:0.3; }

        /* CONFIRM BUTTON */
        .btn { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; padding:18px; background:#333; color:#777; border-radius:14px; border:none; font-weight:800; font-size: 1rem; cursor:not-allowed; text-transform:uppercase; z-index:200; transition:0.3s; letter-spacing: 1px; }
        .btn.active { background:var(--grad); color:#000; cursor:pointer; box-shadow:0 10px 40px rgba(255,215,0,0.2); }

        /* LOADING SPINNER */
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="overlay">
        <div class="spinner" id="ov-spin"></div>
        <div class="icon-lock" id="ov-icon" style="display:none">ðŸ”’</div>
        <h1 class="logo" style="-webkit-text-fill-color:unset; color:var(--gold); font-size:2rem; margin-bottom:10px;" id="ov-title">CHECKING ACCESS</h1>
        <p style="color:#888; font-size:1.1rem; max-width: 300px; line-height: 1.5;" id="ov-msg">Verifying location and device status...</p>
        <button id="perm-btn" style="display:none; margin-top:20px; padding:12px 25px; background:var(--gold); border:none; border-radius:8px; font-weight:bold; cursor:pointer;" onclick="requestLocation()">ALLOW LOCATION ACCESS</button>
    </div>

    <header>
        <span class="badge">Grand Finale</span>
        <div class="logo">The Final Showdown</div>
        <div id="timer">05:00</div>
    </header>
    
    <div class="container blur" id="app">
        <h4>Select 1 Mr. Finalist</h4>
        <div id="l-boys"></div>
        
        <h4>Select 1 Miss Finalist</h4>
        <div id="l-girls"></div>
    </div>
    
    <button class="btn" id="sub" onclick="vote()">Confirm Selection</button>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://rdxknqyszgoymlvqwgrj.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_iS9a8Rk6_wweyISm9GQYbQ_YqFapjAu";
        
        // --- EVENT SETTINGS ---
        // 5 Minute Timer (300 seconds)
        const EVENT_DURATION_MS = 5 * 60 * 1000; 
        
        // GEO-FENCING CONFIG
        const TARGET_LAT = 19.248114;
        const TARGET_LNG = 73.146977;
        const MAX_DISTANCE_METERS = 20; 
        
        // !!! STRICT MODE ACTIVE !!!
        const TEST_MODE = false; 

        // --- FINALISTS DATA (Edit this!) ---
        const DATA = {
            boys: [
                {id: "fb1", name: "Aashish Yadav", role: "TYBCOM Finalist", img: "https://cdn-icons-png.flaticon.com/512/4140/4140048.png"},
                {id: "fb2", name: "Krushnakant Pal", role: "TYBSC CS Finalist", img: "https://cdn-icons-png.flaticon.com/512/4140/4140048.png"}
            ],
            girls: [
                {id: "fg1", name: "Vaidehi Gund", role: "TYBMS Finalist", img: "https://cdn-icons-png.flaticon.com/512/4140/4140047.png"},
                {id: "fg2", name: "Ekta Dixit", role: "TYBSC CS Finalist", img: "https://cdn-icons-png.flaticon.com/512/4140/4140047.png"}
            ]
        };

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const uid = new URLSearchParams(location.search).get('id');
        
        let selectedBoy = null;
        let selectedGirl = null;
        let userLat = 0, userLng = 0;

        window.onload = async () => {
            // 1. Basic ID Check
            if(!uid) return lock('ACCESS DENIED', 'No Student ID found. Use your unique link.', 'ðŸ”’');

            // 2. Start Location Check flow
            document.getElementById('ov-msg').innerHTML = "We need your location to verify<br>you are at the Main Building.";
            document.getElementById('ov-spin').style.display = 'none';
            document.getElementById('perm-btn').style.display = 'block';
        };

        function requestLocation() {
            document.getElementById('perm-btn').style.display = 'none';
            document.getElementById('ov-spin').style.display = 'block';
            document.getElementById('ov-msg').innerText = "Acquiring GPS signal...";

            if (TEST_MODE) {
                console.warn("TEST MODE: Bypassing GPS Check");
                userLat = TARGET_LAT; userLng = TARGET_LNG;
                checkAccess();
            } else {
                if(!navigator.geolocation) return lock("ERROR", "Geolocation is not supported by your browser.", "âš ï¸");
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLat = pos.coords.latitude;
                        userLng = pos.coords.longitude;
                        const dist = getDistance(userLat, userLng, TARGET_LAT, TARGET_LNG);
                        
                        // Strict Distance Check
                        if(dist > MAX_DISTANCE_METERS) {
                            lock("OUT OF RANGE", `You are ${Math.round(dist)}m away. You must be within ${MAX_DISTANCE_METERS}m of the venue.`, "ðŸ“");
                        } else {
                            checkAccess(); // GPS Good, now check DB
                        }
                    },
                    (err) => {
                        let msg = "Location access denied.";
                        if(err.code === 1) msg = "Please allow location access to vote.";
                        else if(err.code === 2) msg = "GPS signal unavailable.";
                        else if(err.code === 3) msg = "Location request timed out.";
                        lock("LOCATION REQUIRED", msg, "ðŸŒ");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }

        async function checkAccess() {
            document.getElementById('ov-msg').innerText = "Checking server status...";
            try {
                // Parallel Check: IP/UA and User Status
                const ipReq = fetch('https://api.ipify.org?format=json').then(r=>r.json());
                const usrReq = sb.from('voter_list').select('has_voted').eq('student_id', uid).single();
                
                const [ipData, usrRes] = await Promise.all([ipReq, usrReq]);

                // A. User Check
                if (!usrRes.data) return lock('INVALID ID', 'Student ID not found in database.', 'ðŸš«');
                if (usrRes.data.has_voted) return lock('ALREADY VOTED', 'You have already cast your final vote.', 'âœ…');

                // B. Device Check (Smart Lock)
                const { data: isLocked } = await sb.rpc('check_device_status', { 
                    p_ip: ipData.ip, 
                    p_ua: navigator.userAgent 
                });

                if (isLocked) {
                    return lock('DEVICE LOCKED', 'This device has already been used.', 'ðŸ“±');
                }

                // C. Unlock App
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('app').classList.remove('blur');
                initApp();
                startTimer();

            } catch(e) {
                console.error(e);
                lock("CONNECTION ERROR", "Could not connect to server. Refresh to try again.", "âš ï¸");
            }
        }

        function initApp() {
            renderList('boys', DATA.boys);
            renderList('girls', DATA.girls);
        }

        function renderList(type, list) {
            const container = document.getElementById(`l-${type}`);
            list.forEach(c => {
                const el = document.createElement('div');
                el.className = 'card';
                el.onclick = () => select(type, c.id);
                el.id = c.id;
                el.innerHTML = `
                    <img src="${c.img}" class="avatar">
                    <div class="info"><div class="name">${c.name}</div><div class="role">${c.role}</div></div>
                    <div class="check"></div>
                `;
                container.appendChild(el);
            });
        }

        function select(type, id) {
            // Deselect others in same category
            const container = document.getElementById(`l-${type}`);
            [...container.children].forEach(c => c.classList.remove('selected'));
            
            // Select clicked
            document.getElementById(id).classList.add('selected');
            
            if(type === 'boys') selectedBoy = id;
            if(type === 'girls') selectedGirl = id;

            updateBtn();
        }

        function updateBtn() {
            const btn = document.getElementById('sub');
            if(selectedBoy && selectedGirl) {
                btn.classList.add('active');
                btn.innerText = "SUBMIT FINAL VOTE";
            } else {
                btn.classList.remove('active');
                btn.innerText = "SELECT 1 BOY & 1 GIRL";
            }
        }

        async function vote() {
            const btn = document.getElementById('sub');
            if(!btn.classList.contains('active')) return;

            const { isConfirmed } = await Swal.fire({
                title: 'Confirm Final Vote?',
                text: 'This is the Grand Finale. You cannot change this.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#FFD700',
                confirmButtonText: 'Yes, Submit',
                background: '#111', color: '#fff'
            });

            if(!isConfirmed) return;

            Swal.fire({title:'Submitting...', didOpen:()=>Swal.showLoading(), background:'#111', color:'#fff', allowOutsideClick:false});

            try {
                const ip = await fetch('https://api.ipify.org?format=json').then(r=>r.json());
                
                const { error } = await sb.rpc('cast_final_vote', {
                    p_student_id: uid,
                    p_boy_id: selectedBoy,
                    p_girl_id: selectedGirl,
                    p_ip: ip.ip,
                    p_ua: navigator.userAgent,
                    p_lat: userLat,
                    p_long: userLng
                });

                if(error) throw error;

                await Swal.fire({
                    title: 'Voted Successfully!',
                    text: 'Thank you for participating in the Grand Finale.',
                    icon: 'success',
                    confirmButtonColor: '#FFD700',
                    background: '#111', color: '#fff'
                });

                location.reload();

            } catch(e) {
                Swal.fire('Submission Failed', e.message, 'error');
            }
        }

        // --- UTILS ---

        function startTimer() {
            let timeLeft = EVENT_DURATION_MS / 1000;
            const display = document.getElementById('timer');
            
            const interval = setInterval(() => {
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = Math.floor(timeLeft % 60).toString().padStart(2, '0');
                display.innerText = `${m}:${s}`;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    lock("TIME UP", "The voting window has closed.", "â°");
                }
                timeLeft--;
            }, 1000);
        }

        // Haversine Formula for Distance (Meters)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function lock(title, msg, icon) {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('ov-spin').style.display = 'none';
            document.getElementById('ov-icon').style.display = 'block';
            document.getElementById('ov-icon').innerText = icon;
            document.getElementById('ov-title').innerText = title;
            document.getElementById('ov-msg').innerText = msg;
            document.getElementById('perm-btn').style.display = 'none';
            document.getElementById('app').classList.add('blur');
        }
    </script>
</body>
</html>
