<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grand Finale | EcoCampus</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg:#050505; --card:#111; --gold:#FFD700; 
            --grad: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #998100 100%);
            --neon-glow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        body { margin:0; background:var(--bg); color:#fff; font-family:'Outfit',sans-serif; padding-bottom:120px; user-select:none; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        header { position:sticky; top:0; z-index:100; background:rgba(5,5,5,0.95); backdrop-filter:blur(10px); padding:15px; border-bottom:1px solid rgba(255,215,0,0.1); text-align:center; }
        .badge { background: #222; color: var(--gold); border: 1px solid rgba(255,215,0,0.3); font-size: 0.6rem; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: inline-block; font-weight: 700; }
        .logo { font-weight:900; font-size:1.6rem; background:var(--grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-transform: uppercase; letter-spacing: -0.5px; }
        #timer { font-size:1rem; font-weight:700; color:var(--gold); margin-top:5px; font-variant-numeric: tabular-nums; }

        .container { max-width:600px; margin:0 auto; padding:20px 15px; }
        
        /* Section Titles */
        h4 { 
            color: #fff; margin: 30px 0 20px; text-align: center;
            text-transform: uppercase; letter-spacing: 2px; font-size: 0.85rem; font-weight: 700; opacity: 0.7;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        h4::before, h4::after { content: ''; height: 1px; width: 30px; background: var(--gold); opacity: 0.5; }

        /* CIRCLE CANDIDATE UI GRID */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 items per row */
            gap: 20px 10px;
            justify-items: center;
        }

        .candidate-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 100px;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .candidate-item:active { transform: scale(0.95); }

        /* The Avatar Ring */
        .img-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            padding: 3px;
            border: 2px solid #333;
            position: relative;
            transition: all 0.3s ease;
            background: #000;
        }

        .candidate-item.selected .img-ring {
            border-color: var(--gold);
            box-shadow: var(--neon-glow);
            transform: scale(1.05);
        }

        .c-avatar {
            width: 100%; height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #222;
            filter: grayscale(100%); /* B&W by default */
            transition: 0.3s;
        }

        .candidate-item.selected .c-avatar {
            filter: grayscale(0%); /* Color when selected */
        }

        /* Checkmark Badge */
        .check-badge {
            position: absolute; bottom: 0; right: 0;
            width: 24px; height: 24px;
            background: var(--grad);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #000; font-weight: 900; font-size: 12px;
            opacity: 0; transform: scale(0);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #000;
            z-index: 10;
        }

        .candidate-item.selected .check-badge {
            opacity: 1; transform: scale(1);
        }

        /* Text Info */
        .c-name {
            margin-top: 10px;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
            color: #aaa;
            line-height: 1.2;
            transition: 0.3s;
        }
        
        .c-role { font-size: 0.65rem; color: #555; text-align: center; margin-top: 2px; }

        .candidate-item.selected .c-name { color: #fff; font-weight: 700; }
        .candidate-item.selected .c-role { color: var(--gold); }

        /* OVERLAYS & UTILS */
        #overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding: 20px; }
        .icon-lock { font-size: 3rem; margin-bottom: 20px; color: #444; }
        .blur { filter:blur(15px); pointer-events:none; opacity:0.3; }

        /* ACTION BUTTON */
        .btn-container {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, #050505 80%, transparent);
            padding: 20px 0 30px;
            display: flex; justify-content: center;
            pointer-events: none; /* Let clicks pass through gradient */
        }
        
        .btn { 
            pointer-events: auto;
            width:90%; max-width:400px; padding:16px; 
            background:#222; color:#555; 
            border-radius: 50px; border:1px solid #333; 
            font-weight:800; font-size: 1rem; 
            cursor:not-allowed; text-transform:uppercase; 
            transition:0.3s; letter-spacing: 1px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        .btn.active { 
            background:var(--grad); color:#000; border-color: transparent;
            cursor:pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        /* LOADING SPINNER */
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="overlay">
        <div class="spinner" id="ov-spin"></div>
        <div class="icon-lock" id="ov-icon" style="display:none">ðŸ”’</div>
        <h1 class="logo" style="-webkit-text-fill-color:unset; color:var(--gold); font-size:1.8rem; margin-bottom:10px;" id="ov-title">CHECKING ACCESS</h1>
        <p style="color:#888; font-size:1rem; max-width: 300px; line-height: 1.5;" id="ov-msg">Verifying location...</p>
        <button id="perm-btn" style="display:none; margin-top:20px; padding:12px 30px; background:var(--gold); border:none; border-radius:50px; font-weight:bold; cursor:pointer;" onclick="requestLocation()">ALLOW LOCATION</button>
    </div>

    <header>
        <span class="badge">Grand Finale â€¢ Live</span>
        <div class="logo">The Final Showdown</div>
        <div id="timer">00:00</div>
    </header>
    
    <div class="container blur" id="app">
        <h4>Select Mr. BKBNC</h4>
        <div id="l-boys" class="candidates-grid"></div>
        
        <h4>Select Miss BKBNC</h4>
        <div id="l-girls" class="candidates-grid"></div>
    </div>
    
    <div class="btn-container">
        <button class="btn" id="sub" onclick="vote()">Select 1 Boy & 1 Girl</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        
        // Using Round 2 Project Keys (Single Choice Logic)
        const SUPABASE_URL = "https://rdxknqyszgoymlvqwgrj.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_iS9a8Rk6_wweyISm9GQYbQ_YqFapjAu";
        
        // --- EVENT SETTINGS ---
        const EVENT_DURATION_MS = 10 * 60 * 1000; // 10 Minutes for Finale
        
        // GEO-FENCING CONFIG (Strict Mode)
        const TARGET_LAT = 19.248114;
        const TARGET_LNG = 73.146977;
        const MAX_DISTANCE_METERS = 30; 
        
        // !!! STRICT DEPLOYMENT MODE !!!
        const TEST_MODE = false; 

        // --- REAL CANDIDATE DATA ---
        const DATA = {
            boys: [
                { id: "b1", name: "Aashish Yadav", role: "TYBCOM", img: "https://i.ibb.co/rK7rNzZz/image.png" },
                { id: "b2", name: "Krushnakant Pal", role: "TYBSC CS", img: "https://i.ibb.co/KxP8J2Qg/image.png" },
                { id: "b3", name: "Suraj Yadav", role: "TYBSC CS", img: "https://i.ibb.co/Hf3nY4yG/image.png" },
                { id: "b4", name: "Yashraj Gaikwad", role: "TYBSC CS", img: "https://i.ibb.co/TMy7100K/1000231792-f742f4fa052e029d67e046b37879c8af-29-4-2025-11-42-50-am-20251218-223157-0000.jpg" },
                { id: "b5", name: "Prasad Jawale", role: "SYBSC CS", img: "https://i.ibb.co/F4fWpF2d/image.png" },
                { id: "b6", name: "Dhananjay Gupta", role: "TYBSC", img: "https://i.ibb.co/Wp5wqgx7/image.png" }
            ],
            girls: [
                { id: "g1", name: "Vaidehi Gund", role: "TYBMS", img: "https://i.ibb.co/pB6gFvH3/image.png" },
                { id: "g2", name: "Ekta Dixit", role: "TYBSC CS", img: "https://i.ibb.co/3YQ2xWJS/image.png" },
                { id: "g3", name: "Divya Nair", role: "SYBSC CS", img: "https://i.ibb.co/j94yBpdH/image.png" },
                { id: "g4", name: "Dharani Mudaliyar", role: "TYBSC CS", img: "https://i.ibb.co/VcnPCMq7/image.png" },
                { id: "g5", name: "Kaustubhi Chavan", role: "TYBSC CS", img: "https://i.ibb.co/4nzgL2Qf/image.png" },
                { id: "g6", name: "Dhani Singh", role: "SYBMS", img: "https://i.ibb.co/JRv3YGF8/image.png" }
            ]
        };

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const uid = new URLSearchParams(location.search).get('id');
        
        let selectedBoy = null;
        let selectedGirl = null;
        let userLat = 0, userLng = 0;

        window.onload = async () => {
            if(!uid) return lock('ACCESS DENIED', 'No Student ID found in URL.', 'ðŸ”’');
            
            // Start Access Flow
            document.getElementById('ov-msg').innerHTML = "Verifying location...<br>Please stand near Main Building.";
            document.getElementById('ov-spin').style.display = 'none';
            document.getElementById('perm-btn').style.display = 'block';
        };

        function requestLocation() {
            document.getElementById('perm-btn').style.display = 'none';
            document.getElementById('ov-spin').style.display = 'block';
            document.getElementById('ov-msg').innerText = "Acquiring GPS signal...";

            if (TEST_MODE) {
                console.warn("TEST MODE: Bypassing GPS Check");
                userLat = TARGET_LAT; userLng = TARGET_LNG;
                checkAccess();
            } else {
                if(!navigator.geolocation) return lock("ERROR", "Geolocation not supported.", "âš ï¸");
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLat = pos.coords.latitude;
                        userLng = pos.coords.longitude;
                        const dist = getDistance(userLat, userLng, TARGET_LAT, TARGET_LNG);
                        
                        // Strict Distance Check
                        if(dist > MAX_DISTANCE_METERS) {
                            lock("OUT OF RANGE", `You are ${Math.round(dist)}m away.<br>Move closer to the Main Building.`, "ðŸ“");
                        } else {
                            checkAccess(); // GPS Good, now check DB
                        }
                    },
                    (err) => {
                        let msg = "Location access denied.";
                        if(err.code === 1) msg = "Please allow location access to vote.";
                        lock("LOCATION REQUIRED", msg, "ðŸŒ");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }

        async function checkAccess() {
            document.getElementById('ov-msg').innerText = "Checking voting status...";
            try {
                // Parallel Check: IP/UA and User Status
                const ipReq = fetch('https://api.ipify.org?format=json').then(r=>r.json());
                const usrReq = sb.from('voter_list').select('has_voted').eq('student_id', uid).single();
                
                const [ipData, usrRes] = await Promise.all([ipReq, usrReq]);

                // A. User Check
                if (!usrRes.data) return lock('INVALID ID', 'Student ID not found.', 'ðŸš«');
                if (usrRes.data.has_voted) return lock('ALREADY VOTED', 'Your vote is already recorded.', 'âœ…');

                // B. Device Check (Smart Lock)
                const { data: isLocked } = await sb.rpc('check_device_status', { 
                    p_ip: ipData.ip, 
                    p_ua: navigator.userAgent 
                });

                if (isLocked) return lock('DEVICE LOCKED', 'This device has already been used.', 'ðŸ“±');

                // C. Unlock App
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('app').classList.remove('blur');
                initApp();
                startTimer();

            } catch(e) {
                console.error(e);
                lock("CONNECTION ERROR", "Could not connect to server.", "âš ï¸");
            }
        }

        function initApp() {
            renderList('boys', DATA.boys);
            renderList('girls', DATA.girls);
        }

        function renderList(type, list) {
            const container = document.getElementById(`l-${type}`);
            container.innerHTML = ""; // Clear existing
            
            list.forEach(c => {
                const el = document.createElement('div');
                el.className = 'candidate-item';
                el.id = c.id;
                el.onclick = () => select(type, c.id);
                
                el.innerHTML = `
                    <div class="img-ring">
                        <img src="${c.img}" class="c-avatar">
                        <div class="check-badge">âœ”</div>
                    </div>
                    <div class="c-name">${c.name.split(' ')[0]}</div>
                    <div class="c-role">${c.role}</div>
                `;
                container.appendChild(el);
            });
        }

        function select(type, id) {
            // Logic: Only 1 selection per category
            const container = document.getElementById(`l-${type}`);
            [...container.children].forEach(c => c.classList.remove('selected'));
            
            const target = document.getElementById(id);
            target.classList.add('selected');
            
            // Vibrations for feedback (Android only)
            if(navigator.vibrate) navigator.vibrate(50);
            
            if(type === 'boys') selectedBoy = id;
            if(type === 'girls') selectedGirl = id;

            updateBtn();
        }

        function updateBtn() {
            const btn = document.getElementById('sub');
            if(selectedBoy && selectedGirl) {
                btn.classList.add('active');
                btn.innerText = "CONFIRM VOTE";
            } else {
                btn.classList.remove('active');
                btn.innerText = "Select 1 Boy & 1 Girl";
            }
        }

        async function vote() {
            const btn = document.getElementById('sub');
            if(!btn.classList.contains('active')) return;

            const { isConfirmed } = await Swal.fire({
                title: 'Confirm Vote?',
                text: 'This is the Grand Finale. You cannot change this.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#FFD700',
                confirmButtonText: 'Yes, Submit',
                background: '#111', color: '#fff'
            });

            if(!isConfirmed) return;

            Swal.fire({title:'Submitting...', didOpen:()=>Swal.showLoading(), background:'#111', color:'#fff', allowOutsideClick:false});

            try {
                const ip = await fetch('https://api.ipify.org?format=json').then(r=>r.json());
                
                const { error } = await sb.rpc('cast_final_vote', {
                    p_student_id: uid,
                    p_boy_id: selectedBoy,
                    p_girl_id: selectedGirl,
                    p_ip: ip.ip,
                    p_ua: navigator.userAgent,
                    p_lat: userLat,
                    p_long: userLng
                });

                if(error) throw error;

                await Swal.fire({
                    title: 'Voted Successfully!',
                    text: 'Thank you for participating.',
                    icon: 'success',
                    confirmButtonColor: '#FFD700',
                    background: '#111', color: '#fff'
                });

                location.reload();

            } catch(e) {
                Swal.fire('Submission Failed', e.message, 'error');
            }
        }

        // --- UTILS ---
        function startTimer() {
            let timeLeft = EVENT_DURATION_MS / 1000;
            const display = document.getElementById('timer');
            
            const interval = setInterval(() => {
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = Math.floor(timeLeft % 60).toString().padStart(2, '0');
                display.innerText = `${m}:${s}`;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    lock("TIME UP", "The voting window has closed.", "â°");
                }
                timeLeft--;
            }, 1000);
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius meters
            const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function lock(title, msg, icon) {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('ov-spin').style.display = 'none';
            document.getElementById('ov-icon').style.display = 'block';
            document.getElementById('ov-icon').innerText = icon;
            document.getElementById('ov-title').innerText = title;
            document.getElementById('ov-msg').innerHTML = msg;
            document.getElementById('perm-btn').style.display = 'none';
            document.getElementById('app').classList.add('blur');
        }
    </script>
</body>
</html>
