<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Results | EcoCampus</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg:#0a0a0b; --card:#161618; --gold:#D4AF37; 
            --grad:linear-gradient(135deg,#BF953F,#FCF6BA,#B38728,#FBF5B7); 
            --text-muted: #666;
        }
        
        body { 
            margin:0; background:var(--bg); color:#fff; font-family:'Outfit',sans-serif; 
            overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }

        /* HEADER */
        header { 
            height: 80px; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 40px; border-bottom: 1px solid #222; background: rgba(10,10,11,0.95);
        }
        .logo { font-size: 1.8rem; font-weight: 900; background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; letter-spacing: -1px; }
        .live-indicator { display: flex; align-items: center; font-size: 0.9rem; color: var(--gold); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .dot { width: 10px; height: 10px; background: red; border-radius: 50%; margin-right: 10px; box-shadow: 0 0 10px red; animation: pulse 1.5s infinite; }
        
        /* MAIN GRID */
        .dashboard { 
            flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; padding: 30px 40px;
            height: calc(100vh - 80px); box-sizing: border-box;
        }
        
        .column { display: flex; flex-direction: column; height: 100%; }
        
        .col-header { 
            font-size: 1.2rem; font-weight: 800; color: #fff; text-transform: uppercase; 
            letter-spacing: 2px; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .total-votes { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }

        /* LIST CONTAINER */
        .rank-list { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        /* CANDIDATE CARD */
        .card { 
            display: flex; align-items: center; 
            background: #141414; border: 1px solid #222; border-radius: 12px; 
            padding: 10px 15px; position: relative; overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        /* Top 3 Highlighting */
        .card[data-rank="1"] { border-color: var(--gold); background: linear-gradient(90deg, #1c1c1e 0%, #2a2200 100%); transform: scale(1.02); }
        .card[data-rank="1"] .rank-num { color: var(--gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        
        .rank-num { width: 40px; font-size: 1.2rem; font-weight: 800; color: #444; text-align: center; margin-right: 15px; z-index: 2; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #333; z-index: 2; background: #000; }
        .info { flex: 1; z-index: 2; }
        .name { font-weight: 700; font-size: 1.1rem; line-height: 1.2; }
        .role { font-size: 0.8rem; color: #666; }

        .score { text-align: right; z-index: 2; }
        .count { font-size: 1.4rem; font-weight: 800; color: #fff; line-height: 1; }
        .label { font-size: 0.6rem; text-transform: uppercase; color: var(--gold); font-weight: 700; }

        /* PROGRESS BAR BEHIND */
        .progress-bar {
            position: absolute; top: 0; left: 0; height: 100%;
            background: rgba(255, 255, 255, 0.03);
            width: 0%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        .card[data-rank="1"] .progress-bar { background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.15)); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="logo">EcoCampus Results</div>
        <div class="live-indicator"><div class="dot"></div> Live Counting</div>
    </header>

    <div class="dashboard">
        <div class="column">
            <div class="col-header">
                Mr. Nominees
                <span class="total-votes" id="total-boys">0 Votes</span>
            </div>
            <div class="rank-list" id="list-boys"></div>
        </div>

        <div class="column">
            <div class="col-header">
                Miss Nominees
                <span class="total-votes" id="total-girls">0 Votes</span>
            </div>
            <div class="rank-list" id="list-girls"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION (MATCHING YOUR VOTING PAGE) ---
        const SUPABASE_URL = "https://uvlwqlddmanuzeuqtjxp.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_LIyHXHGq6pqfAcWw-QCz9g_N9lfVNOA";
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // DATA MAPPING
        const CANDIDATES = {
            'b1': {name:"Aashish Yadav", role:"TYBCOM", img:""},
            'b2': {name:"Krushnakant Pal", role:"TYBSC CS", img:""},
            'b3': {name:"Suraj Yadav", role:"TYBSC CS", img:""},
            'b4': {name:"Yashraj Gaikwad", role:"TYBSC CS", img:"https://i.ibb.co/Zz9Nhdnv/image.png"},
            'b5': {name:"Prasad Jawale", role:"SYBSC CS", img:"https://i.ibb.co/F4fWpF2d/image.png"},
            'b6': {name:"Dhananjay Gupta", role:"TYBSC", img:""},
            
            'g1': {name:"Vaidehi Gund", role:"TYBMS", img:""},
            'g2': {name:"Ekta Dixit", role:"TYBSC CS", img:""},
            'g3': {name:"Divya Nair", role:"SYBSC CS", img:""},
            'g4': {name:"Dharani Mudaliyar", role:"TYBSC CS", img:"https://i.ibb.co/VcnPCMq7/image.png"},
            'g5': {name:"Kaustubhi Chavan", role:"TYBSC CS", img:""},
            'g6': {name:"Dhani Singh", role:"SYBMS", img:""}
        };

        // Track leader to trigger confetti
        let prevLeaderBoy = null;

        async function fetchResults() {
            try {
                // Call the WEIGHTED results function (Round 1 Logic)
                const { data, error } = await sb.rpc('get_weighted_results');
                if (error) throw error;

                // Process Data
                const boys = processCategory('boys', data);
                const girls = processCategory('girls', data);

                renderColumn('boys', boys);
                renderColumn('girls', girls);

                // Confetti if leader changes
                if (boys.length > 0 && boys[0].points > 0 && boys[0].id !== prevLeaderBoy) {
                    prevLeaderBoy = boys[0].id;
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }

            } catch (err) {
                console.error("Sync Error:", err);
            }
        }

        function processCategory(cat, dbData) {
            // Filter DB results for this category
            const categoryData = dbData.filter(r => r.category === cat);
            
            // Map to Candidate List
            // Note: We scan CANDIDATES keys to find those belonging to this category prefix
            const prefix = cat === 'boys' ? 'b' : 'g';
            
            const list = Object.keys(CANDIDATES)
                .filter(id => id.startsWith(prefix))
                .map(id => {
                    const record = categoryData.find(r => r.candidate_id === id);
                    return {
                        id: id,
                        ...CANDIDATES[id],
                        points: record ? record.total_points : 0,
                        votes: record ? record.vote_count : 0
                    };
                });
            
            // Sort by Total Points (Weighted)
            return list.sort((a, b) => b.points - a.points);
        }

        function renderColumn(type, list) {
            const container = document.getElementById(`list-${type}`);
            const totalEl = document.getElementById(`total-${type}`);
            
            // Sum votes (vote_count from DB represents how many people voted for them at any rank)
            // But usually in preferential, we just count total voters. 
            // Here we just sum up the 'vote count' column which tells us how many ballots included this candidate.
            // Since every ballot includes every candidate in your logic, we can just take the max vote count of the leader.
            const totalVotes = list.length > 0 ? list[0].votes : 0;
            totalEl.innerText = `${totalVotes} Voters`;

            // Max points for progress bar
            const max = list.length > 0 ? list[0].points : 1;

            container.innerHTML = list.map((c, i) => {
                const rank = i + 1;
                const percent = max > 0 ? (c.points / max) * 100 : 0;
                
                return `
                <div class="card" data-rank="${rank}" id="${c.id}">
                    <div class="progress-bar" style="width:${percent}%"></div>
                    <div class="rank-num">${rank}</div>
                    <img src="${c.img || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="avatar">
                    <div class="info">
                        <div class="name">${c.name}</div>
                        <div class="role">${c.role}</div>
                    </div>
                    <div class="score">
                        <div class="count">${c.points}</div>
                        <div class="label">Points</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Init & Interval
        fetchResults();
        setInterval(fetchResults, 2000); 

    </script>
</body>
</html>
