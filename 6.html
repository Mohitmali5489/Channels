<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Results | EcoCampus</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --bg:#0a0a0b; --card:#161618; --gold:#D4AF37; 
            --text-muted: #888;
            --grad:linear-gradient(135deg,#BF953F,#FCF6BA,#B38728,#FBF5B7); 
        }
        body { margin:0; background:var(--bg); color:#fff; font-family:'Outfit',sans-serif; padding:20px; }
        
        /* Header */
        header { text-align:center; margin-bottom:40px; }
        h1 { font-weight:800; font-size:2.5rem; margin:0; background:var(--grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .status { color:var(--text-muted); font-size:0.9rem; margin-top:5px; font-variant-numeric: tabular-nums; }

        /* Grid Layout */
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:40px; max-width:1200px; margin:0 auto; }
        @media(max-width: 768px) { .grid { grid-template-columns: 1fr; } }

        .column h2 { color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px; font-size:1.2rem; letter-spacing: 1px; text-transform: uppercase; }

        /* Leaderboard Card */
        .rank-card { 
            display:flex; align-items:center; 
            background:var(--card); 
            border:1px solid rgba(255,255,255,0.05); 
            border-radius:12px; 
            padding:15px; 
            margin-bottom:12px; 
            transition:0.3s;
            position: relative;
            overflow: hidden;
        }

        /* Top 3 Highlighting */
        .rank-card[data-rank="1"] { border-color: #FFD700; background: linear-gradient(90deg, #1c1c1e, #2a2a00); }
        .rank-card[data-rank="2"] { border-color: #C0C0C0; }
        .rank-card[data-rank="3"] { border-color: #CD7F32; }

        /* Rank Number */
        .pos { 
            font-size:1.5rem; font-weight:800; width:40px; color:#555; 
            text-align:center; margin-right:15px; 
        }
        .rank-card[data-rank="1"] .pos { color: #FFD700; }
        .rank-card[data-rank="2"] .pos { color: #C0C0C0; }
        .rank-card[data-rank="3"] .pos { color: #CD7F32; }

        .avatar { width:50px; height:50px; border-radius:50%; object-fit:cover; margin-right:15px; background:#333; border:2px solid #333; }
        .info { flex:1; }
        .name { font-weight:700; font-size:1.1rem; }
        .role { font-size:0.8rem; color:#aaa; }
        
        /* Scores */
        .score-box { text-align:right; }
        .points { font-size:1.4rem; font-weight:800; color:#fff; display:block; line-height: 1; }
        .pts-label { font-size:0.7rem; color:var(--gold); font-weight:600; text-transform: uppercase; }
        .votes { font-size:0.7rem; color:#666; margin-top:2px; }

        /* Progress Bar Background */
        .progress-bg {
            position: absolute; bottom: 0; left: 0; height: 3px; background: var(--gold); opacity: 0.5; width: 0%; transition: width 1s ease;
        }

        /* Loading State */
        .loading { text-align: center; color: #666; padding: 20px; font-style: italic; }

    </style>
</head>
<body>

    <header>
        <h1>LIVE RESULTS</h1>
        <div class="status">Auto-refreshing every 5s â€¢ <span id="last-update">Waiting...</span></div>
    </header>

    <div class="grid">
        <div class="column">
            <h2>Mr. BKBNC Leaderboard</h2>
            <div id="list-boys"><div class="loading">Loading data...</div></div>
        </div>

        <div class="column">
            <h2>Miss BKBNC Leaderboard</h2>
            <div id="list-girls"><div class="loading">Loading data...</div></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // !!! PASTE THE SAME KEYS HERE AS YOUR VOTING PAGE !!!
        const SUPABASE_URL = "https://uvlwqlddmanuzeuqtjxp.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_LIyHXHGq6pqfAcWw-QCz9g_N9lfVNOA";

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Static Candidate Data (Must match Voting Page IDs)
        const CANDIDATES = {
            'b1': {name:"Aashish Yadav", role:"TYBCOM", img:""},
            'b2': {name:"Krushnakant Pal", role:"TYBSC CS", img:""},
            'b3': {name:"Suraj Yadav", role:"TYBSC CS", img:""},
            'b4': {name:"Yashraj Gaikwad", role:"TYBSC CS", img:"https://i.ibb.co/Zz9Nhdnv/image.png"},
            'b5': {name:"Prasad Jawale", role:"SYBSC CS", img:"https://i.ibb.co/F4fWpF2d/image.png"},
            'b6': {name:"Dhananjay Gupta", role:"TYBSC", img:""},
            'g1': {name:"Vaidehi Gund", role:"TYBMS", img:""},
            'g2': {name:"Ekta Dixit", role:"TYBSC CS", img:""},
            'g3': {name:"Divya Nair", role:"SYBSC CS", img:""},
            'g4': {name:"Dharani Mudaliyar", role:"TYBSC CS", img:"https://i.ibb.co/VcnPCMq7/image.png"},
            'g5': {name:"Kaustubhi Chavan", role:"TYBSC CS", img:""},
            'g6': {name:"Dhani Singh", role:"SYBMS", img:""}
        };

        async function fetchResults() {
            try {
                // Call the SQL function we created earlier
                const { data, error } = await sb.rpc('get_weighted_results');
                if (error) throw error;

                renderList('boys', data.filter(r => r.category === 'boys'));
                renderList('girls', data.filter(r => r.category === 'girls'));

                // Update Timestamp
                const now = new Date();
                document.getElementById('last-update').innerText = `Updated: ${now.toLocaleTimeString()}`;

            } catch (err) {
                console.error("Error fetching results:", err);
            }
        }

        function renderList(type, data) {
            const container = document.getElementById(`list-${type}`);
            
            // 1. Map static data to results
            // Note: DB returns specific rows. We also need to show candidates with 0 votes.
            // So we start with the full candidate list for this category.
            const prefix = type === 'boys' ? 'b' : 'g';
            const allCandidates = Object.keys(CANDIDATES)
                .filter(id => id.startsWith(prefix))
                .map(id => {
                    const dbRecord = data.find(r => r.candidate_id === id);
                    return {
                        id: id,
                        ...CANDIDATES[id],
                        points: dbRecord ? dbRecord.total_points : 0,
                        votes: dbRecord ? dbRecord.vote_count : 0
                    };
                });

            // 2. Sort by Points (Highest first)
            allCandidates.sort((a, b) => b.points - a.points);

            // 3. Find max points for progress bar calculation
            const maxPoints = allCandidates.length > 0 ? allCandidates[0].points : 100;

            // 4. Generate HTML
            let html = '';
            allCandidates.forEach((c, index) => {
                const rank = index + 1;
                const percentage = maxPoints > 0 ? (c.points / maxPoints) * 100 : 0;
                
                html += `
                <div class="rank-card" data-rank="${rank}">
                    <div class="pos">${rank}</div>
                    <img src="${c.img || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="avatar">
                    <div class="info">
                        <div class="name">${c.name}</div>
                        <div class="role">${c.role}</div>
                    </div>
                    <div class="score-box">
                        <span class="points">${c.points}</span>
                        <span class="pts-label">Points</span>
                        <div class="votes">${c.votes} votes</div>
                    </div>
                    <div class="progress-bg" style="width:${percentage}%"></div>
                </div>`;
            });

            container.innerHTML = html;
        }

        // Initial Load
        fetchResults();

        // Refresh every 5 seconds
        setInterval(fetchResults, 5000);

    </script>
</body>
</html>
